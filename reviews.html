<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviews & Ratings - FastSync</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Lucide Icons
        const Star = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
        );
        
        const ThumbsUp = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
            </svg>
        );
        
        const Award = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="8" r="6"></circle><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"></path>
            </svg>
        );
        
        const MessageSquare = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        );
        
        const X = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const ArrowLeft = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        );

        const RatingReviewSystem = () => {
          const [reviews, setReviews] = useState([]);
          const [userRating, setUserRating] = useState(null);
          const [showReviewModal, setShowReviewModal] = useState(false);
          const [selectedPartner, setSelectedPartner] = useState(null);
          const [completedPartnerships, setCompletedPartnerships] = useState([]);
          const [currentUser, setCurrentUser] = useState(null);
          const [rating, setRating] = useState(0);
          const [hoverRating, setHoverRating] = useState(0);
          const [reviewText, setReviewText] = useState('');
          const [categories, setCategories] = useState({
            communication: 0,
            skills: 0,
            reliability: 0,
            professionalism: 0
          });

          useEffect(() => {
            // Get the actual logged-in user from your FastSync system
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            
            if (!loggedInUser) {
              alert('Please login first!');
              window.location.href = 'login.html';
              return;
            }

            setCurrentUser(loggedInUser);
            loadCompletedPartnerships(loggedInUser.email);
            loadUserRating(loggedInUser.email);
          }, []);

          const loadCompletedPartnerships = async (userEmail) => {
            try {
              const stored = await window.storage.get(`completed_partnerships:${userEmail}`);
              if (stored) {
                setCompletedPartnerships(JSON.parse(stored.value));
              } else {
                setCompletedPartnerships([]);
              }
            } catch (error) {
              console.log('No completed partnerships yet');
              setCompletedPartnerships([]);
            }
          };

          const loadUserRating = async (userEmail) => {
            try {
              const stored = await window.storage.get(`user_rating:${userEmail}`);
              if (stored) {
                setUserRating(JSON.parse(stored.value));
              } else {
                // Initialize with default rating
                const defaultRating = {
                  overall: 0,
                  totalReviews: 0,
                  communication: 0,
                  skills: 0,
                  reliability: 0,
                  professionalism: 0,
                  breakdown: { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 }
                };
                setUserRating(defaultRating);
                await window.storage.set(`user_rating:${userEmail}`, JSON.stringify(defaultRating));
              }
            } catch (error) {
              setUserRating({
                overall: 0,
                totalReviews: 0,
                communication: 0,
                skills: 0,
                reliability: 0,
                professionalism: 0,
                breakdown: { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 }
              });
            }
            loadReviews(userEmail);
          };

          const loadReviews = async (userEmail) => {
            try {
              const stored = await window.storage.get(`reviews:${userEmail}`);
              if (stored) {
                setReviews(JSON.parse(stored.value));
              } else {
                setReviews([]);
              }
            } catch (error) {
              setReviews([]);
            }
          };

          const openReviewModal = (partner) => {
            setSelectedPartner(partner);
            setShowReviewModal(true);
            setRating(0);
            setReviewText('');
            setCategories({ communication: 0, skills: 0, reliability: 0, professionalism: 0 });
          };

          const submitReview = async () => {
            if (rating === 0 || !reviewText.trim()) {
              alert('Please provide a rating and review text');
              return;
            }

            const newReview = {
              id: `r${Date.now()}`,
              reviewerId: currentUser.email,
              reviewerName: currentUser.name || currentUser.username,
              reviewerAvatar: (currentUser.name || currentUser.username).substring(0, 2).toUpperCase(),
              rating,
              text: reviewText,
              categories,
              date: new Date().getTime(),
              helpful: 0
            };

            try {
              // Save review for the partner
              const partnerReviews = await window.storage.get(`reviews:${selectedPartner.partnerEmail}`);
              const reviews = partnerReviews ? JSON.parse(partnerReviews.value) : [];
              reviews.unshift(newReview);
              await window.storage.set(`reviews:${selectedPartner.partnerEmail}`, JSON.stringify(reviews));

              // Update partner's overall rating
              const partnerRating = await window.storage.get(`user_rating:${selectedPartner.partnerEmail}`);
              let ratingData = partnerRating ? JSON.parse(partnerRating.value) : {
                overall: 0,
                totalReviews: 0,
                communication: 0,
                skills: 0,
                reliability: 0,
                professionalism: 0,
                breakdown: { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 }
              };

              // Update rating statistics
              ratingData.totalReviews += 1;
              ratingData.breakdown[rating] = (ratingData.breakdown[rating] || 0) + 1;
              
              // Calculate new averages
              const totalRatings = ratingData.totalReviews;
              ratingData.communication = ((ratingData.communication * (totalRatings - 1)) + categories.communication) / totalRatings;
              ratingData.skills = ((ratingData.skills * (totalRatings - 1)) + categories.skills) / totalRatings;
              ratingData.reliability = ((ratingData.reliability * (totalRatings - 1)) + categories.reliability) / totalRatings;
              ratingData.professionalism = ((ratingData.professionalism * (totalRatings - 1)) + categories.professionalism) / totalRatings;
              ratingData.overall = ((ratingData.overall * (totalRatings - 1)) + rating) / totalRatings;

              await window.storage.set(`user_rating:${selectedPartner.partnerEmail}`, JSON.stringify(ratingData));

              // Update partnership as reviewed
              const updatedPartnerships = completedPartnerships.map(p =>
                p.id === selectedPartner.id ? { ...p, hasReviewed: true } : p
              );
              setCompletedPartnerships(updatedPartnerships);
              await window.storage.set(`completed_partnerships:${currentUser.email}`, JSON.stringify(updatedPartnerships));

              setShowReviewModal(false);
              alert('Review submitted successfully!');
            } catch (error) {
              console.error('Error submitting review:', error);
              alert('Error submitting review. Please try again.');
            }
          };

          const StarRating = ({ value, onChange, size = 'md', readonly = false }) => {
            const sizeClasses = {
              sm: 'w-4 h-4',
              md: 'w-6 h-6',
              lg: 'w-8 h-8'
            };

            return (
              <div className="flex gap-1">
                {[1, 2, 3, 4, 5].map(star => (
                  <button
                    key={star}
                    type="button"
                    disabled={readonly}
                    onClick={() => !readonly && onChange(star)}
                    onMouseEnter={() => !readonly && setHoverRating(star)}
                    onMouseLeave={() => !readonly && setHoverRating(0)}
                    className={`${readonly ? 'cursor-default' : 'cursor-pointer hover:scale-110'} transition`}
                  >
                    <Star
                      className={`${sizeClasses[size]} ${
                        star <= (hoverRating || value)
                          ? 'fill-yellow-400 text-yellow-400'
                          : 'text-gray-300'
                      }`}
                    />
                  </button>
                ))}
              </div>
            );
          };

          const formatDate = (timestamp) => {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          };

          if (!currentUser) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                  <h2 className="text-2xl font-bold text-gray-800 mb-4">Please Login</h2>
                  <p className="text-gray-600 mb-4">You need to be logged in to view reviews</p>
                  <a href="login.html" className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Go to Login
                  </a>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50">
              {/* Navigation Bar */}
              <nav className="bg-white shadow-sm border-b border-gray-200 mb-8">
                <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <a href="index.html" className="text-gray-600 hover:text-gray-800">
                      <ArrowLeft className="w-6 h-6" />
                    </a>
                    <h1 className="text-xl font-bold text-gray-800">My Reviews & Ratings</h1>
                  </div>
                  <div className="text-sm text-gray-600">
                    Logged in as: <strong>{currentUser.name || currentUser.username}</strong>
                  </div>
                </div>
              </nav>

              <div className="max-w-6xl mx-auto px-4 pb-8">
                {/* Rating Overview Card */}
                {userRating && (
                  <div className="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <div className="flex flex-col md:flex-row gap-8">
                      <div className="flex-shrink-0 text-center md:border-r md:pr-8">
                        <div className="text-5xl font-bold text-gray-800 mb-2">
                          {userRating.overall > 0 ? userRating.overall.toFixed(1) : '0.0'}
                        </div>
                        <StarRating value={Math.round(userRating.overall)} readonly size="md" />
                        <p className="text-gray-600 mt-2">{userRating.totalReviews} reviews</p>
                      </div>

                      <div className="flex-1">
                        <h3 className="font-semibold text-gray-800 mb-4">Rating Breakdown</h3>
                        {[5, 4, 3, 2, 1].map(star => (
                          <div key={star} className="flex items-center gap-3 mb-2">
                            <span className="text-sm text-gray-600 w-12">{star} stars</span>
                            <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-yellow-400"
                                style={{ 
                                  width: userRating.totalReviews > 0 
                                    ? `${(userRating.breakdown[star] / userRating.totalReviews) * 100}%` 
                                    : '0%' 
                                }}
                              />
                            </div>
                            <span className="text-sm text-gray-600 w-8">{userRating.breakdown[star]}</span>
                          </div>
                        ))}
                      </div>

                      <div className="flex-1">
                        <h3 className="font-semibold text-gray-800 mb-4">Category Scores</h3>
                        <div className="space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-sm text-gray-600">Communication</span>
                            <div className="flex items-center gap-2">
                              <StarRating value={Math.round(userRating.communication)} readonly size="sm" />
                              <span className="text-sm font-semibold">{userRating.communication.toFixed(1)}</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-sm text-gray-600">Skills</span>
                            <div className="flex items-center gap-2">
                              <StarRating value={Math.round(userRating.skills)} readonly size="sm" />
                              <span className="text-sm font-semibold">{userRating.skills.toFixed(1)}</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-sm text-gray-600">Reliability</span>
                            <div className="flex items-center gap-2">
                              <StarRating value={Math.round(userRating.reliability)} readonly size="sm" />
                              <span className="text-sm font-semibold">{userRating.reliability.toFixed(1)}</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-sm text-gray-600">Professionalism</span>
                            <div className="flex items-center gap-2">
                              <StarRating value={Math.round(userRating.professionalism)} readonly size="sm" />
                              <span className="text-sm font-semibold">{userRating.professionalism.toFixed(1)}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Pending Reviews */}
                {completedPartnerships.filter(p => !p.hasReviewed).length > 0 && (
                  <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                      <MessageSquare className="w-5 h-5 text-blue-600" />
                      Pending Reviews
                    </h2>
                    <div className="space-y-3">
                      {completedPartnerships.filter(p => !p.hasReviewed).map(partner => (
                        <div key={partner.id} className="bg-white rounded-lg p-4 flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold">
                              {partner.partnerAvatar}
                            </div>
                            <div>
                              <h3 className="font-semibold text-gray-800">{partner.partnerName}</h3>
                              <p className="text-sm text-gray-600">{partner.partnerSkills}</p>
                              <p className="text-xs text-gray-500">Completed {formatDate(partner.completedDate)}</p>
                            </div>
                          </div>
                          <button
                            onClick={() => openReviewModal(partner)}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                          >
                            Write Review
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Reviews List */}
                <div className="bg-white rounded-xl shadow-sm p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-6">Recent Reviews</h2>
                  {reviews.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <Award className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                      <p className="mb-2">No reviews yet</p>
                      <p className="text-sm">Complete partnerships and get reviews to build your reputation!</p>
                    </div>
                  ) : (
                    <div className="space-y-6">
                      {reviews.map(review => (
                        <div key={review.id} className="border-b border-gray-100 pb-6 last:border-0">
                          <div className="flex items-start gap-4">
                            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-white font-semibold flex-shrink-0">
                              {review.reviewerAvatar}
                            </div>
                            <div className="flex-1">
                              <div className="flex items-start justify-between mb-2">
                                <div>
                                  <h3 className="font-semibold text-gray-800">{review.reviewerName}</h3>
                                  <div className="flex items-center gap-2 mt-1">
                                    <StarRating value={review.rating} readonly size="sm" />
                                    <span className="text-sm text-gray-600">{formatDate(review.date)}</span>
                                  </div>
                                </div>
                              </div>
                              <p className="text-gray-700 mb-3">{review.text}</p>
                              <div className="flex flex-wrap gap-4 text-sm">
                                <span className="text-gray-600">
                                  <strong>Communication:</strong> {review.categories.communication}/5
                                </span>
                                <span className="text-gray-600">
                                  <strong>Skills:</strong> {review.categories.skills}/5
                                </span>
                                <span className="text-gray-600">
                                  <strong>Reliability:</strong> {review.categories.reliability}/5
                                </span>
                                <span className="text-gray-600">
                                  <strong>Professionalism:</strong> {review.categories.professionalism}/5
                                </span>
                              </div>
                              <button className="mt-3 text-sm text-gray-500 hover:text-blue-600 flex items-center gap-1">
                                <ThumbsUp className="w-4 h-4" />
                                Helpful ({review.helpful})
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Review Modal */}
              {showReviewModal && selectedPartner && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
                    <div className="flex items-center justify-between mb-6">
                      <h2 className="text-2xl font-bold text-gray-800">Write a Review</h2>
                      <button onClick={() => setShowReviewModal(false)} className="text-gray-500 hover:text-gray-700">
                        <X className="w-6 h-6" />
                      </button>
                    </div>

                    <div className="flex items-center gap-3 mb-6 p-4 bg-gray-50 rounded-lg">
                      <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold">
                        {selectedPartner.partnerAvatar}
                      </div>
                      <div>
                        <h3 className="font-semibold text-gray-800">{selectedPartner.partnerName}</h3>
                        <p className="text-sm text-gray-600">{selectedPartner.partnerSkills}</p>
                      </div>
                    </div>

                    <div className="space-y-6">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Overall Rating *
                        </label>
                        <StarRating value={rating} onChange={setRating} size="lg" />
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Communication</label>
                          <StarRating
                            value={categories.communication}
                            onChange={(val) => setCategories({ ...categories, communication: val })}
                            size="md"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Skills</label>
                          <StarRating
                            value={categories.skills}
                            onChange={(val) => setCategories({ ...categories, skills: val })}
                            size="md"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Reliability</label>
                          <StarRating
                            value={categories.reliability}
                            onChange={(val) => setCategories({ ...categories, reliability: val })}
                            size="md"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Professionalism</label>
                          <StarRating
                            value={categories.professionalism}
                            onChange={(val) => setCategories({ ...categories, professionalism: val })}
                            size="md"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Your Review *
                        </label>
                        <textarea
                          value={reviewText}
                          onChange={(e) => setReviewText(e.target.value)}
                          placeholder="Share your experience working with this partner..."
                          rows="5"
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>

                      <div className="flex gap-3">
                        <button
                          onClick={submitReview}
                          className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"
                        >
                          Submit Review
                        </button>
                        <button
                          onClick={() => setShowReviewModal(false)}
                          className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        ReactDOM.render(<RatingReviewSystem />, document.getElementById('root'));
    </script>
</body>
</html>
